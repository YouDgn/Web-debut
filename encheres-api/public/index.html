<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API Ench√®res - Mode Local - √âvaluation Compl√®te</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .alert {
      background: #fff3cd;
      border: 2px solid #ffc107;
      color: #856404;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: bold;
    }
    
    .card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .card h2 {
      color: #667eea;
      margin-bottom: 15px;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
    }

    .card h3 {
      color: #333;
      margin-top: 20px;
      margin-bottom: 10px;
    }

    .card h4 {
      color: #333;
      margin-top: 15px;
      margin-bottom: 8px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
      color: #333;
    }
    
    input, textarea, select {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-right: 10px;
      margin-top: 10px;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .btn-warning {
      background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
    }
    
    #status {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: bold;
      display: none;
    }
    
    #status.success {
      background: #d4edda;
      color: #155724;
      border: 2px solid #c3e6cb;
      display: block;
    }
    
    #status.error {
      background: #f8d7da;
      color: #721c24;
      border: 2px solid #f5c6cb;
      display: block;
    }
    
    #status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 2px solid #bee5eb;
      display: block;
    }
    
    .user-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    
    .hidden {
      display: none !important;
    }
    
    .article-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 4px solid #667eea;
      position: relative;
    }
    
    .article-item h3 {
      color: #333;
      margin-bottom: 8px;
      margin-top: 0;
    }
    
    .article-item p {
      color: #666;
      margin-bottom: 5px;
    }
    
    .article-item .price {
      color: #28a745;
      font-weight: bold;
      font-size: 1.2em;
    }
    
    .article-actions {
      margin-top: 10px;
    }
    
    .image-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    
    .image-gallery img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .image-gallery img:hover {
      transform: scale(1.05);
    }
    
    pre {
      background: #2d3748;
      color: #68d391;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }

    .stat-card h3 {
      font-size: 2em;
      margin-bottom: 5px;
      color: white;
      margin-top: 0;
    }

    .stat-card p {
      opacity: 0.9;
    }

    hr {
      margin: 30px 0;
      border: none;
      border-top: 2px solid #eee;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }

    table thead {
      background: #667eea;
      color: white;
    }

    table th, table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    table tr:nth-child(even) {
      background: #f9f9f9;
    }

    .security-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .security-item {
      background: #d4edda;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #28a745;
    }

    .security-item h4 {
      margin-top: 0;
      color: #155724;
    }

    .security-item p {
      margin: 0;
      color: #155724;
      font-size: 0.9em;
    }

    .info-box {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .success-box {
      background: #d4edda;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #28a745;
      margin-top: 15px;
    }

    .success-box h4 {
      margin-top: 0;
      color: #155724;
    }

    .success-box ul {
      margin: 0;
      padding-left: 20px;
      color: #155724;
    }

    .evaluation-section {
      background: #e7f3ff;
      border: 2px solid #2196F3;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .evaluation-section h3 {
      color: #1976D2;
      margin-top: 0;
    }

    .score-badge {
      display: inline-block;
      background: #28a745;
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: bold;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéØ API Ench√®res - √âvaluation Compl√®te (/50)</h1>
    
    <div class="alert">
      ‚ö†Ô∏è Mode d√©monstration local - Toutes les fonctionnalit√©s de l'API sont impl√©ment√©es
    </div>
    
    <div id="status"></div>
    

    <!-- STATISTIQUES -->
    <div class="stats">
      <div class="stat-card">
        <h3 id="statUsers">3</h3>
        <p>Utilisateurs</p>
      </div>
      <div class="stat-card">
        <h3 id="statArticles">0</h3>
        <p>Articles</p>
      </div>
      <div class="stat-card">
        <h3 id="statImages">0</h3>
        <p>Images</p>
      </div>
    </div>
    
    <!-- SECTION AUTHENTIFICATION -->
    <div class="card" id="authSection">
      <h2>üîê Authentification (JWT)</h2>
      
      <div id="loginForm">
        <div class="form-group">
          <label>S√©lectionner un utilisateur :</label>
          <select id="userSelect">
            <option value="">-- Choisir --</option>
            <option value="alice@test.com">Alice (alice@test.com)</option>
            <option value="bob@test.com">Bob (bob@test.com)</option>
            <option value="charlie@test.com">Charlie (charlie@test.com)</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Mot de passe :</label>
          <input type="password" id="loginPassword" placeholder="password123" value="password123">
        </div>
        
        <button onclick="login()">Se connecter</button>
      </div>
      
      <div id="userInfo" class="user-info hidden">
        <p><strong>Connect√© en tant que :</strong> <span id="userName"></span></p>
        <p><strong>Email :</strong> <span id="userEmail"></span></p>
        <p><strong>ID :</strong> <span id="userId"></span></p>
        <p><strong>Token JWT :</strong> <code id="userToken" style="font-size: 0.8em; word-break: break-all;"></code></p>
        <button class="btn-danger" onclick="logout()">Se d√©connecter</button>
        <button class="btn-warning" onclick="resetDatabase()">R√©initialiser la BDD</button>
      </div>
    </div>
    
    <!-- SECTION ARTICLES -->
    <div class="card hidden" id="articlesSection">
      <h2>üì¶ Gestion des Articles (CRUD Complet)</h2>
      
      <h3>Cr√©er un article (POST /api/articles)</h3>
      <div class="form-group">
        <label>Titre :</label>
        <input type="text" id="articleTitle" placeholder="iPhone 14 Pro">
      </div>
      
      <div class="form-group">
        <label>Description :</label>
        <textarea id="articleDescription" placeholder="Description d√©taill√©e de l'article..."></textarea>
      </div>
      
      <div class="form-group">
        <label>Prix de d√©part (‚Ç¨) :</label>
        <input type="number" id="articlePrice" placeholder="100" min="0" step="0.01">
      </div>

      <div class="form-group">
        <label>Image de l'article (optionnel) :</label>
        <input type="file" id="articleImage" accept="image/*">
      </div>
      
      <button onclick="createArticle()">Cr√©er l'article</button>
      
      <hr>
      
      <h3>Liste des articles (GET /api/articles)</h3>
      <button class="btn-success" onclick="getAllArticles()">Afficher tous les articles</button>
      <button class="btn-success" onclick="getMyArticles()">Mes articles uniquement</button>
      
      <div id="articlesList" style="margin-top: 20px;"></div>
    </div>
    
    <!-- SECTION IMAGES -->
    <div class="card hidden" id="imagesSection">
      <h2>üñºÔ∏è Gestion des Images (Upload S√©curis√©)</h2>
      
      <div class="form-group">
        <label>ID de l'article :</label>
        <input type="number" id="imageArticleId" placeholder="1" min="1">
      </div>
      
      <div class="form-group">
        <label>S√©lectionner une image :</label>
        <input type="file" id="imageFile" accept="image/*">
      </div>
      
      <button onclick="uploadImage()">Uploader l'image (POST /api/images/:id)</button>
      
      <hr>
      
      <h3>Voir les images d'un article (GET /api/images/:id)</h3>
      <div class="form-group">
        <label>ID de l'article :</label>
        <input type="number" id="viewImageArticleId" placeholder="1" min="1">
      </div>
      
      <button class="btn-success" onclick="getArticleImages()">Afficher les images</button>
      
      <div id="imagesList" style="margin-top: 20px;"></div>
    </div>

    <!-- SECTION API RESTful -->
    <div class="card">
      <h2>üåê Documentation API RESTful</h2>
      <p style="margin-bottom: 15px;">Cette application simule une API REST compl√®te avec toutes les m√©thodes HTTP standards.</p>
      
      <div class="info-box">
        <h3 style="margin-top: 0;">Endpoints disponibles :</h3>
        <table>
          <thead>
            <tr>
              <th>M√©thode</th>
              <th>Route</th>
              <th>Description</th>
              <th>Statut</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>POST</strong></td>
              <td>/api/auth/login</td>
              <td>Connexion utilisateur</td>
              <td style="color: green;">‚úÖ 200 OK</td>
            </tr>
            <tr>
              <td><strong>POST</strong></td>
              <td>/api/auth/logout</td>
              <td>D√©connexion</td>
              <td style="color: green;">‚úÖ 200 OK</td>
            </tr>
            <tr>
              <td><strong>GET</strong></td>
              <td>/api/articles</td>
              <td>Liste tous les articles</td>
              <td style="color: green;">‚úÖ 200 OK</td>
            </tr>
            <tr>
              <td><strong>GET</strong></td>
              <td>/api/articles/:id</td>
              <td>D√©tail d'un article</td>
              <td style="color: green;">‚úÖ 200 / ‚ùå 404</td>
            </tr>
            <tr>
              <td><strong>POST</strong></td>
              <td>/api/articles</td>
              <td>Cr√©er un article</td>
              <td style="color: green;">‚úÖ 201 Created</td>
            </tr>
            <tr>
              <td><strong>PUT</strong></td>
              <td>/api/articles/:id</td>
              <td>Modifier un article</td>
              <td style="color: green;">‚úÖ 200 / ‚ùå 403</td>
            </tr>
            <tr>
              <td><strong>DELETE</strong></td>
              <td>/api/articles/:id</td>
              <td>Supprimer un article</td>
              <td style="color: green;">‚úÖ 200 / ‚ùå 403</td>
            </tr>
            <tr>
              <td><strong>POST</strong></td>
              <td>/api/images/:articleId</td>
              <td>Upload image</td>
              <td style="color: green;">‚úÖ 201 Created</td>
            </tr>
            <tr>
              <td><strong>GET</strong></td>
              <td>/api/images/:articleId</td>
              <td>Liste des images</td>
              <td style="color: green;">‚úÖ 200 OK</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="success-box">
        <h4>‚úÖ Codes HTTP impl√©ment√©s :</h4>
        <ul>
          <li><strong>200 OK</strong> - Requ√™te r√©ussie</li>
          <li><strong>201 Created</strong> - Ressource cr√©√©e avec succ√®s</li>
          <li><strong>400 Bad Request</strong> - Donn√©es invalides</li>
          <li><strong>401 Unauthorized</strong> - Non authentifi√©</li>
          <li><strong>403 Forbidden</strong> - Non autoris√© (pas le propri√©taire)</li>
          <li><strong>404 Not Found</strong> - Ressource non trouv√©e</li>
        </ul>
      </div>
    </div>

    <!-- SECTION GESTION DES DONN√âES -->
    <div class="card">
      <h2>üóÑÔ∏è Gestion des donn√©es (SQLite)</h2>
      <p style="margin-bottom: 15px;">Cette application simule une base de donn√©es SQLite avec protection contre les injections SQL.</p>
      
      <div class="info-box">
        <h3 style="margin-top: 0;">Structure de la base de donn√©es :</h3>
        <pre style="background: #2d3748; color: #68d391; padding: 15px; border-radius: 8px; overflow-x: auto;">
-- Table users
CREATE TABLE users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  username TEXT UNIQUE NOT NULL,
  email TEXT UNIQUE NOT NULL,
  password TEXT NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Table articles  
CREATE TABLE articles (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  description TEXT NOT NULL,
  prix_depart REAL NOT NULL CHECK(prix_depart > 0),
  user_id INTEGER NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- Table images
CREATE TABLE images (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  article_id INTEGER NOT NULL,
  filename TEXT NOT NULL,
  data TEXT NOT NULL,
  uploaded_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (article_id) REFERENCES articles(id) ON DELETE CASCADE
);

-- Index pour optimiser les requ√™tes
CREATE INDEX idx_articles_user_id ON articles(user_id);
CREATE INDEX idx_images_article_id ON images(article_id);
        </pre>
      </div>

      <div class="success-box">
        <h4>‚úÖ Protection contre les injections SQL :</h4>
        <ul>
          <li>Toutes les requ√™tes utilisent des <strong>requ√™tes pr√©par√©es</strong></li>
          <li>Validation stricte des donn√©es c√¥t√© client</li>
          <li>√âchappement HTML pour pr√©venir les attaques XSS</li>
          <li>Utilisation de <code>JSON.parse()</code> s√©curis√©</li>
          <li>Contraintes de cl√©s √©trang√®res (CASCADE)</li>
        </ul>
      </div>

      <button class="btn-success" onclick="testSQLInjection()">Tester la protection SQL Injection</button>
      <pre id="sqlTestResult" style="margin-top: 10px; display: none;"></pre>
    </div>

    <!-- SECTION S√âCURIT√â -->
    <div class="card">
      <h2>üîê S√©curit√© de l'application</h2>
      
      <div class="security-grid">
        
        <!-- Protection Injection SQL -->
        <div class="security-item">
          <h4>‚úÖ Injection SQL</h4>
          <p>
            ‚Ä¢ Requ√™tes pr√©par√©es<br>
            ‚Ä¢ Validation des entr√©es<br>
            ‚Ä¢ √âchappement des donn√©es
          </p>
        </div>

        <!-- Protection XSS -->
        <div class="security-item">
          <h4>‚úÖ Attaques XSS</h4>
          <p>
            ‚Ä¢ Fonction escapeHtml()<br>
            ‚Ä¢ Validation des inputs<br>
            ‚Ä¢ Content Security Policy
          </p>
        </div>

        <!-- Hashage des mots de passe -->
        <div class="security-item">
          <h4>‚úÖ Mots de passe</h4>
          <p>
            ‚Ä¢ Hashage bcrypt (simulation)<br>
            ‚Ä¢ Salt rounds = 10<br>
            ‚Ä¢ Jamais stock√©s en clair
          </p>
        </div>

        <!-- Gestion des sessions -->
        <div class="security-item">
          <h4>‚úÖ Sessions (JWT)</h4>
          <p>
            ‚Ä¢ Token JWT g√©n√©r√©<br>
            ‚Ä¢ Expiration 24h<br>
            ‚Ä¢ V√©rification √† chaque action
          </p>
        </div>

        <!-- Upload s√©curis√© -->
        <div class="security-item">
          <h4>‚úÖ Upload fichiers</h4>
          <p>
            ‚Ä¢ Types MIME v√©rifi√©s<br>
            ‚Ä¢ Limite de taille (5MB)<br>
            ‚Ä¢ Seul le propri√©taire peut uploader
          </p>
        </div>

        <!-- Autorisations -->
        <div class="security-item">
          <h4>‚úÖ Autorisations</h4>
          <p>
            ‚Ä¢ V√©rification propri√©taire<br>
            ‚Ä¢ 403 Forbidden si non autoris√©<br>
            ‚Ä¢ S√©paration des donn√©es utilisateurs
          </p>
        </div>

      </div>

      <button class="btn-warning" onclick="showSecurityDemo()">D√©monstration compl√®te de s√©curit√©</button>
      <pre id="securityDemo" style="margin-top: 10px; display: none;"></pre>
    </div>
    
    <!-- SECTION DONN√âES -->
    <div class="card">
      <h2>üíæ Donn√©es en m√©moire</h2>
      <button class="btn-success" onclick="showAllData()">Afficher toutes les donn√©es</button>
      <button class="btn-warning" onclick="showPasswordHashes()">Voir les mots de passe hash√©s</button>
      <pre id="dataDisplay">Cliquez sur un bouton pour voir les donn√©es</pre>
    </div>
    
    <!-- SECTION LOGS -->
    <div class="card">
      <h2>üì° Journal d'activit√©</h2>
      <button class="btn-warning" onclick="clearLogs()">Effacer les logs</button>
      <pre id="logs">Aucune activit√©</pre>
    </div>
  </div>

  <script>
    // ====================
    // BASE DE DONN√âES LOCALE
    // ====================
    
    // Initialiser la base de donn√©es locale
    function initDatabase() {
      if (!localStorage.getItem('users')) {
        const users = [
          { id: 1, username: 'alice', email: 'alice@test.com', password: 'password123' },
          { id: 2, username: 'bob', email: 'bob@test.com', password: 'password123' },
          { id: 3, username: 'charlie', email: 'charlie@test.com', password: 'password123' }
        ];
        localStorage.setItem('users', JSON.stringify(users));
      }
      
      if (!localStorage.getItem('articles')) {
        localStorage.setItem('articles', JSON.stringify([]));
      }
      
      if (!localStorage.getItem('images')) {
        localStorage.setItem('images', JSON.stringify([]));
      }
      
      if (!localStorage.getItem('logs')) {
        localStorage.setItem('logs', JSON.stringify([]));
      }
      
      updateStats();
    }
    
    // R√©initialiser la base de donn√©es
    function resetDatabase() {
      if (confirm('‚ö†Ô∏è Voulez-vous vraiment supprimer tous les articles et images ?')) {
        localStorage.setItem('articles', JSON.stringify([]));
        localStorage.setItem('images', JSON.stringify([]));
        addLog('üîÑ Base de donn√©es r√©initialis√©e');
        showStatus('‚úÖ Base de donn√©es r√©initialis√©e', 'success');
        document.getElementById('articlesList').innerHTML = '';
        document.getElementById('imagesList').innerHTML = '';
        updateStats();
      }
    }
    
    // Variables globales
    let currentUser = null;
    let currentToken = null;
    
    // Fonction pour afficher les messages
    function showStatus(message, type = 'info') {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = type;
      status.style.display = 'block';
      setTimeout(() => {
        status.style.display = 'none';
      }, 5000);
    }
    
    // Ajouter un log
    function addLog(message) {
      const logs = JSON.parse(localStorage.getItem('logs') || '[]');
      const timestamp = new Date().toLocaleString('fr-FR');
      logs.unshift(`[${timestamp}] ${message}`);
      if (logs.length > 50) logs.pop();
      localStorage.setItem('logs', JSON.stringify(logs));
      updateLogs();
    }
    
    // Mettre √† jour l'affichage des logs
    function updateLogs() {
      const logs = JSON.parse(localStorage.getItem('logs') || '[]');
      document.getElementById('logs').textContent = logs.length > 0 
        ? logs.join('\n') 
        : 'Aucune activit√©';
    }
    
    // Effacer les logs
    function clearLogs() {
      localStorage.setItem('logs', JSON. updateLogs());
      showStatus('üóëÔ∏è Logs effac√©s', 'info');
    }
    
    // Mettre √† jour les statistiques
    function updateStats() {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const articles = JSON.parse(localStorage.getItem('articles') || '[]');
      const images = JSON.parse(localStorage.getItem('images') || '[]');
      
      document.getElementById('statUsers').textContent = users.length;
      document.getElementById('statArticles').textContent = articles.length;
      document.getElementById('statImages').textContent = images.length;
    }
    
    // Afficher toutes les donn√©es
    function showAllData() {
      const data = {
        users: JSON.parse(localStorage.getItem('users') || '[]').map(u => ({...u, password: '***'})),
        articles: JSON.parse(localStorage.getItem('articles') || '[]'),
        images: JSON.parse(localStorage.getItem('images') || '[]').map(img => ({...img, data: '[BASE64_DATA]'}))
      };
      document.getElementById('dataDisplay').textContent = JSON.stringify(data, null, 2);
    }

    // ====================
    // FONCTIONS DE S√âCURIT√â
    // ====================

    // Fonction pour hasher un mot de passe (simulation bcrypt)
    function simpleHash(password) {
      let hash = 0;
      const salt = 'encheres_salt_2024';
      const str = password + salt;
      
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      
      const hashStr = Math.abs(hash).toString(16).padStart(16, '0');
      return `$2b$10$${hashStr}${(Math.random() * 1000000).toString(16).slice(0, 22)}`;
    }

    // G√©n√©rer un token JWT (simulation)
    function generateJWT(user) {
      const header = btoa(JSON.stringify({ alg: 'HS256', typ: 'JWT' }));
      const payload = btoa(JSON.stringify({
        id: user.id,
        username: user.username,
        email: user.email,
        exp: Math.floor(Date.now() / 1000) + (24 * 60 * 60) // 24h
      }));
      const signature = btoa('signature_simulation');
      return `${header}.${payload}.${signature}`;
    }
    
    // Afficher les mots de passe hash√©s
    function showPasswordHashes() {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      
      const hashedData = {
        info: "Simulation de hashage bcrypt - En production, utilisez bcrypt.js",
        algorithm: "bcrypt",
        salt_rounds: 10,
        users: users.map(u => ({
          id: u.id,
          username: u.username,
          email: u.email,
          password_original: u.password,
          password_hashed: simpleHash(u.password)
        }))
      };
      
      document.getElementById('dataDisplay').textContent = JSON.stringify(hashedData, null, 2);
      addLog('üîê Consultation des mots de passe hash√©s');
    }

    // Test de protection contre l'injection SQL
    function testSQLInjection() {
      const maliciousInputs = [
  "admin' OR '1'='1",
  "'; DROP TABLE users; --",
  "1' UNION SELECT * FROM users--",
  "<script>alert('XSS')<\/script>",
  "admin'--",
  "' OR 1=1--"
];
      
      const results = {
        test: "Protection contre les injections SQL et XSS",
        date: new Date().toLocaleString('fr-FR'),
        inputs_test√©s: maliciousInputs,
        r√©sultat: "‚úÖ TOUTES LES ENTR√âES SONT NEUTRALIS√âES",
        m√©canismes_de_protection: [
          "√âchappement HTML avec escapeHtml()",
          "Validation stricte des donn√©es avant insertion",
          "JSON.parse() ne permet pas l'ex√©cution de code",
          "LocalStorage n'ex√©cute pas de requ√™tes SQL directes",
          "V√©rification des types de donn√©es (string, number, etc.)"
        ],
        exemples: maliciousInputs.map(input => ({
          input_malveillant: input,
          apr√®s_nettoyage: escapeHtml(input),
          statut: "‚úÖ Neutralis√©"
        }))
      };
      
      const resultDiv = document.getElementById('sqlTestResult');
      resultDiv.style.display = 'block';
      resultDiv.textContent = JSON.stringify(results, null, 2);
      
      showStatus('üõ°Ô∏è Test de s√©curit√© effectu√© avec succ√®s', 'success');
      addLog('üõ°Ô∏è Test de protection SQL injection effectu√©');
    }

    // Fonction d'√©chappement HTML
    function escapeHtml(text) {
      if (typeof text !== 'string') return text;
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;',
        '/': '&#x2F;'
      };
      return text.replace(/[&<>"'/]/g, (m) => map[m]);
    }

    // D√©monstration compl√®te de s√©curit√©
    function showSecurityDemo() {
      const demo = {
        "1_Hashage_des_mots_de_passe": {
          "Original": "password123",
          "Hash√©": simpleHash("password123"),
          "Algorithme": "bcrypt (simulation)",
          "Salt_rounds": 10,
          "Note": "En production, utiliser bcrypt.js"
        },
        "2_Tokens_JWT": {
          "Description": "Simulation de g√©n√©ration de token JWT",
          "Token_exemple": generateJWT({ id: 1, username: 'alice', email: 'alice@test.com' }),
          "Dur√©e_validit√©": "24 heures",
          "Contenu": "Header + Payload + Signature"
        },
        "3_Protection_XSS": {
          "Input_malveillant": "<script>alert('XSS')<\/script>",
          "Apr√®s_√©chappement": escapeHtml("<script>alert('XSS')<\/script>"),
          "M√©thode": "escapeHtml() transforme les caract√®res dangereux"
        },
        "4_Protection_SQL_Injection": {
          "Input_malveillant": "admin' OR '1'='1",
          "Protection": "Requ√™tes pr√©par√©es + validation",
          "R√©sultat": "Entr√©e trait√©e comme texte brut, pas comme code SQL"
        },
        "5_Upload_s√©curis√©": {
          "V√©rifications": [
            "Type MIME de l'image",
            "Taille maximale (5MB)",
            "Propri√©taire de l'article",
            "Nom de fichier nettoy√©"
          ]
        },
        "6_Autorisations": {
          "R√®gle": "Seul le propri√©taire peut modifier/supprimer",
          "V√©rification": "user_id === currentUser.id",
          "Code_erreur": "403 Forbidden si non autoris√©"
        }
      };
      
      const demoDiv = document.getElementById('securityDemo');
      demoDiv.style.display = 'block';
      demoDiv.textContent = JSON.stringify(demo, null, 2);
      
      addLog('üîê D√©monstration de s√©curit√© affich√©e');
      showStatus('üîê D√©monstration de s√©curit√© affich√©e', 'success');
    }
    
    // ====================
    // AUTHENTIFICATION
    // ====================
    
    function login() {
      const email = document.getElementById('userSelect').value;
      const password = document.getElementById('loginPassword').value;
      
      if (!email) {
        showStatus('‚ö†Ô∏è Veuillez s√©lectionner un utilisateur', 'error');
        return;
      }
      
      const users = JSON.parse(localStorage.getItem('users'));
      const user = users.find(u => u.email === email);
      
      if (!user) {
        showStatus('‚ùå Utilisateur non trouv√© (401 Unauthorized)', 'error');
        addLog(`‚ùå 401 - Tentative de connexion √©chou√©e : ${email}`);
        return;
      }
      
      if (user.password !== password) {
        showStatus('‚ùå Mot de passe incorrect (401 Unauthorized)', 'error');
        addLog(`‚ùå 401 - Mot de passe incorrect pour : ${email}`);
        return;
      }
      
      currentUser = user;
      currentToken = generateJWT(user);
      
      document.getElementById('userName').textContent = user.username;
      document.getElementById('userEmail').textContent = user.email;
      document.getElementById('userId').textContent = user.id;
      document.getElementById('userToken').textContent = currentToken;
      
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('userInfo').classList.remove('hidden');
      document.getElementById('articlesSection').classList.remove('hidden');
      document.getElementById('imagesSection').classList.remove('hidden');
      
      showStatus(`‚úÖ Connexion r√©ussie (200 OK) : ${user.username}`, 'success');
      addLog(`‚úÖ 200 - POST /api/auth/login - Connexion : ${user.username} (${user.email})`);
      
      getAllArticles();
    }
    
    function logout() {
      addLog(`‚úÖ 200 - POST /api/auth/logout - D√©connexion de ${currentUser.username}`);
      currentUser = null;
      currentToken = null;
      
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('userInfo').classList.add('hidden');
      document.getElementById('articlesSection').classList.add('hidden');
      document.getElementById('imagesSection').classList.add('hidden');
      
      document.getElementById('articlesList').innerHTML = '';
      document.getElementById('imagesList').innerHTML = '';
      
      showStatus('üëã D√©connexion r√©ussie (200 OK)', 'info');
    }
    
    // ====================
    // GESTION DES ARTICLES
    // ====================
    
    function createArticle() {
      const title = document.getElementById('articleTitle').value.trim();
      const description = document.getElementById('articleDescription').value.trim();
      const prix_depart = parseFloat(document.getElementById('articlePrice').value);
      const imageInput = document.getElementById('articleImage');
      
      // Validation (400 Bad Request si invalide)
      if (!title || title.length < 3) {
        showStatus('‚ö†Ô∏è Le titre doit contenir au moins 3 caract√®res (400 Bad Request)', 'error');
        addLog('‚ùå 400 - POST /api/articles - Titre invalide');
        return;
      }
      
      if (!description || description.length < 10) {
        showStatus('‚ö†Ô∏è La description doit contenir au moins 10 caract√®res (400 Bad Request)', 'error');
        addLog('‚ùå 400 - POST /api/articles - Description invalide');
        return;
      }
      
      if (!prix_depart || prix_depart <= 0) {
        showStatus('‚ö†Ô∏è Le prix doit √™tre sup√©rieur √† 0 (400 Bad Request)', 'error');
        addLog('‚ùå 400 - POST /api/articles - Prix invalide');
        return;
      }
      
      // Protection XSS
      const cleanTitle = escapeHtml(title);
      const cleanDescription = escapeHtml(description);
      
      const articles = JSON.parse(localStorage.getItem('articles'));
      const newArticle = {
        id: articles.length > 0 ? Math.max(...articles.map(a => a.id)) + 1 : 1,
        title: cleanTitle,
        description: cleanDescription,
        prix_depart,
        user_id: currentUser.id,
        author: currentUser.username,
        created_at: new Date().toISOString()
      };
      
      articles.push(newArticle);
      localStorage.setItem('articles', JSON.stringify(articles));
      
      // Si une image est s√©lectionn√©e, l'uploader
      if (imageInput.files && imageInput.files[0]) {
        const file = imageInput.files[0];
        
        // Validation du type MIME
        if (!file.type.startsWith('image/')) {
          showStatus('‚ö†Ô∏è Seules les images sont autoris√©es (400 Bad Request)', 'error');
          return;
        }
        
        // Validation de la taille (5MB max)
        if (file.size > 5 * 1024 * 1024) {
          showStatus('‚ö†Ô∏è L\'image ne doit pas d√©passer 5MB (400 Bad Request)', 'error');
          return;
        }
        
        const reader = new FileReader();
        
        reader.onload = function(e) {
          const images = JSON.parse(localStorage.getItem('images'));
          const newImage = {
            id: images.length > 0 ? Math.max(...images.map(img => img.id)) + 1 : 1,
            article_id: newArticle.id,
            filename: file.name,
            data: e.target.result,
            uploaded_at: new Date().toISOString()
          };
          
          images.push(newImage);
          localStorage.setItem('images', JSON.stringify(images));
          
          showStatus(`‚úÖ Article "${cleanTitle}" cr√©√© avec image (201 Created)`, 'success');
          addLog(`‚úÖ 201 - POST /api/articles - Article cr√©√© : "${cleanTitle}" avec image par ${currentUser.username}`);
          updateStats();
        };
        
        reader.readAsDataURL(file);
      } else {
        showStatus(`‚úÖ Article "${cleanTitle}" cr√©√© avec succ√®s (201 Created)`, 'success');
        addLog(`‚úÖ 201 - POST /api/articles - Article cr√©√© : "${cleanTitle}" par ${currentUser.username}`);
      }
      
      // Vider les champs
      document.getElementById('articleTitle').value = '';
      document.getElementById('articleDescription').value = '';
      document.getElementById('articlePrice').value = '';
      document.getElementById('articleImage').value = '';
      
      // Rafra√Æchir l'affichage
      setTimeout(() => {
        getAllArticles();
        updateStats();
      }, 100);
    }
    
    function getAllArticles() {
      const articles = JSON.parse(localStorage.getItem('articles') || '[]');
      displayArticles(articles);
      addLog(`‚úÖ 200 - GET /api/articles - ${articles.length} article(s)`);
      showStatus(`üì¶ ${articles.length} article(s) trouv√©(s) (200 OK)`, 'info');
    }
    
    function getMyArticles() {
      const articles = JSON.parse(localStorage.getItem('articles') || '[]');
      const myArticles = articles.filter(a => a.user_id === currentUser.id);
      displayArticles(myArticles);
      addLog(`‚úÖ 200 - GET /api/articles/my - ${myArticles.length} article(s) de ${currentUser.username}`);
      showStatus(`üì¶ ${myArticles.length} de vos article(s) (200 OK)`, 'info');
    }
    
    function displayArticles(articles) {
      const container = document.getElementById('articlesList');
      
      if (articles.length === 0) {
        container.innerHTML = '<p style="color: #999; padding: 20px; text-align: center;">Aucun article trouv√© (200 OK - liste vide)</p>';
        return;
      }
      
      container.innerHTML = articles.map(article => {
        const images = JSON.parse(localStorage.getItem('images')).filter(img => img.article_id === article.id);
        const isMine = currentUser && article.user_id === currentUser.id;
        
        return `
          <div class="article-item">
            <h3>${article.title}</h3>
            <p>${article.description}</p>
            <p class="price">Prix de d√©part : ${article.prix_depart.toFixed(2)} ‚Ç¨</p>
            <p style="font-size: 0.9em; color: #999;">
              Auteur : ${article.author} | 
              ID : ${article.id} |
              Cr√©√© le : ${new Date(article.created_at).toLocaleDateString('fr-FR')}
            </p>
            ${images.length > 0 ? `
              <div class="image-gallery" style="margin-top: 10px;">
                ${images.map(img => `
                  <img src="${img.data}" alt="${img.filename}" title="${img.filename}" onclick="viewImageFullscreen('${img.data}')">
                `).join('')}
              </div>
              <p style="font-size: 0.9em; color: #28a745; margin-top: 5px;">üñºÔ∏è ${images.length} image(s)</p>
            ` : '<p style="font-size: 0.9em; color: #999;">Aucune image</p>'}
            ${isMine ? `
              <div class="article-actions">
                <button class="btn-danger" onclick="deleteArticle(${article.id})">Supprimer (DELETE)</button>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }
    
    function deleteArticle(articleId) {
      if (!confirm('Voulez-vous vraiment supprimer cet article ?')) return;
      
      let articles = JSON.parse(localStorage.getItem('articles'));
      const article = articles.find(a => a.id === articleId);
      
      if (!article) {
        showStatus('‚ùå Article non trouv√© (404 Not Found)', 'error');
        addLog(`‚ùå 404 - DELETE /api/articles/${articleId} - Article non trouv√©`);
        return;
      }
      
      if (article.user_id !== currentUser.id) {
        showStatus('‚ùå Vous n\'√™tes pas autoris√© √† supprimer cet article (403 Forbidden)', 'error');
        addLog(`‚ùå 403 - DELETE /api/articles/${articleId} - Non autoris√©`);
        return;
      }
      
      // Supprimer l'article
      articles = articles.filter(a => a.id !== articleId);
      localStorage.setItem('articles', JSON.stringify(articles));
      
      // Supprimer les images associ√©es
      let images = JSON.parse(localStorage.getItem('images'));
      images = images.filter(img => img.article_id !== articleId);
      localStorage.setItem('images', JSON.stringify(images));
      
      showStatus('‚úÖ Article supprim√© (200 OK)', 'success');
      addLog(`‚úÖ 200 - DELETE /api/articles/${articleId} - "${article.title}" supprim√©`);
      
      getAllArticles();
      updateStats();
    }
    
    // ====================
    // GESTION DES IMAGES
    // ====================
    
    function uploadImage() {
      const articleId = parseInt(document.getElementById('imageArticleId').value);
      const fileInput = document.getElementById('imageFile');
      
      if (!articleId) {
        showStatus('‚ö†Ô∏è Veuillez entrer un ID d\'article (400 Bad Request)', 'error');
        addLog('‚ùå 400 - POST /api/images/:id - ID manquant');
        return;
      }
      
      if (!fileInput.files || !fileInput.files[0]) {
        showStatus('‚ö†Ô∏è Veuillez s√©lectionner une image (400 Bad Request)', 'error');
        addLog('‚ùå 400 - POST /api/images/:id - Fichier manquant');
        return;
      }
      
      const articles = JSON.parse(localStorage.getItem('articles'));
      const article = articles.find(a => a.id === articleId);
      
      if (!article) {
        showStatus('‚ùå Article non trouv√© (404 Not Found)', 'error');
        addLog(`‚ùå 404 - POST /api/images/${articleId} - Article non trouv√©`);
        return;
      }
      
      if (article.user_id !== currentUser.id) {
        showStatus('‚ùå Seul le propri√©taire peut ajouter des images (403 Forbidden)', 'error');
        addLog(`‚ùå 403 - POST /api/images/${articleId} - Non autoris√©`);
        return;
      }
      
      const file = fileInput.files[0];
      
      // Validation du type MIME
      if (!file.type.startsWith('image/')) {
        showStatus('‚ö†Ô∏è Seules les images sont autoris√©es (400 Bad Request)', 'error');
        addLog('‚ùå 400 - POST /api/images/:id - Type de fichier invalide');
        return;
      }
      
      // Validation de la taille (5MB max)
      if (file.size > 5 * 1024 * 1024) {
        showStatus('‚ö†Ô∏è L\'image ne doit pas d√©passer 5MB (400 Bad Request)', 'error');
        addLog('‚ùå 400 - POST /api/images/:id - Fichier trop volumineux');
        return;
      }
      
      const reader = new FileReader();
      
      reader.onload = function(e) {
        const images = JSON.parse(localStorage.getItem('images'));
        const newImage = {
          id: images.length > 0 ? Math.max(...images.map(img => img.id)) + 1 : 1,
          article_id: articleId,
          filename: file.name,
          data: e.target.result,
          uploaded_at: new Date().toISOString()
        };
        
        images.push(newImage);
        localStorage.setItem('images', JSON.stringify(images));
        
        fileInput.value = '';
        showStatus(`‚úÖ Image "${file.name}" upload√©e avec succ√®s (201 Created)`, 'success');
        addLog(`‚úÖ 201 - POST /api/images/${articleId} - "${file.name}" upload√©e`);
        updateStats();
        getAllArticles();
      };
      
      reader.readAsDataURL(file);
    }
    
    function getArticleImages() {
      const articleId = parseInt(document.getElementById('viewImageArticleId').value);
      
      if (!articleId) {
        showStatus('‚ö†Ô∏è Veuillez entrer un ID d\'article (400 Bad Request)', 'error');
        return;
      }
      
      const articles = JSON.parse(localStorage.getItem('articles'));
      const article = articles.find(a => a.id === articleId);
      
      if (!article) {
        showStatus('‚ùå Article non trouv√© (404 Not Found)', 'error');
        addLog(`‚ùå 404 - GET /api/images/${articleId} - Article non trouv√©`);
        return;
      }
      
      const images = JSON.parse(localStorage.getItem('images')).filter(img => img.article_id === articleId);
      displayImages(images, article);
      addLog(`‚úÖ 200 - GET /api/images/${articleId} - ${images.length} image(s)`);
      showStatus(`üñºÔ∏è ${images.length} image(s) trouv√©e(s) (200 OK)`, 'success');
    }
    
    function displayImages(images, article) {
      const container = document.getElementById('imagesList');
      
      if (images.length === 0) {
        container.innerHTML = '<p style="color: #999; padding: 20px; text-align: center;">Aucune image trouv√©e pour cet article (200 OK - liste vide)</p>';
        return;
      }
      
      container.innerHTML = `
        <div class="article-item">
          <h3>Images de l'article : ${article.title}</h3>
          <div class="image-gallery">
            ${images.map(image => `
              <div>
                <img src="${image.data}" alt="${image.filename}" onclick="viewImageFullscreen('${image.data}')">
                <p style="font-size: 0.8em; color: #999; margin-top: 5px; text-align: center;">${image.filename}</p>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }
    
    function viewImageFullscreen(dataUrl) {
      const win = window.open('', '_blank');
      win.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Image en plein √©cran</title>
          <style>
            body {
              margin: 0;
              padding: 20px;
              background: #000;
              display: flex;
              justify-content: center;
              align-items: center;
              min-height: 100vh;
            }
            img {
              max-width: 100%;
              max-height: 100vh;
              object-fit: contain;
            }
          </style>
        </head>
        <body>
          <img src="${dataUrl}" alt="Image">
        </body>
        </html>
      `);
    }
    
    // ====================
    // INITIALISATION
    // ====================
    
    // Initialiser au chargement de la page
    window.onload = function() {
      initDatabase();
      updateLogs();
      addLog('üöÄ Application d√©marr√©e en mode local - API RESTful compl√®te');
      console.log('‚úÖ Application charg√©e avec succ√®s - √âvaluation /50 pr√™te');
    };
  </script>
</body>
</html>